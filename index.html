<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chad Dashboard v2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #12171f;
            --bg-tertiary: #1a2028;
            --bg-card: #151b24;
            --border: #2a3441;
            --text-primary: #e6edf3;
            --text-secondary: #7d8590;
            --text-muted: #484f58;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
            --accent-cyan: #39c5cf;
            --gradient-1: linear-gradient(135deg, #58a6ff, #a371f7);
            --gradient-2: linear-gradient(135deg, #3fb950, #39c5cf);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .avatar-container {
            position: relative;
            width: 52px;
            height: 52px;
        }

        .avatar {
            font-size: 36px;
            line-height: 52px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            filter: drop-shadow(0 0 8px rgba(88, 166, 255, 0.3));
        }

        .avatar:hover { transform: scale(1.1); }

        .avatar-ring {
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid transparent;
            background: var(--gradient-1) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            to { transform: rotate(360deg); }
        }

        .avatar-status {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent-green);
            border: 3px solid var(--bg-secondary);
        }

        .avatar-status.offline { background: var(--text-muted); }
        .avatar-status.connecting { background: var(--accent-yellow); animation: pulse 1s infinite; }

        .header-title h1 {
            font-size: 22px;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-title p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
        }

        .status-dot.offline { background: var(--text-muted); }
        .status-dot.connecting { background: var(--accent-yellow); animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .time-display {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
            color: var(--text-secondary);
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .config-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .config-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        /* Main Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 16px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Card Base */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .card:hover {
            border-color: var(--accent-blue);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .card-title-icon { font-size: 14px; }

        .card-badge {
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .card-badge.live {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .card-content {
            padding: 16px;
        }

        /* Gateway Status Card */
        .gateway-status {
            grid-column: span 4;
        }

        .status-grid {
            display: grid;
            gap: 12px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .status-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-value {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            font-weight: 500;
        }

        .status-value.online { color: var(--accent-green); }
        .status-value.offline { color: var(--text-muted); }

        /* Model Info Card */
        .model-info {
            grid-column: span 4;
        }

        .model-display {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .model-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-purple);
        }

        .model-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .model-tag {
            padding: 4px 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Sessions Card */
        .sessions-card {
            grid-column: span 4;
        }

        .session-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .session-stat {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .session-stat-value {
            font-size: 28px;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .session-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Token Usage Card */
        .token-usage {
            grid-column: span 6;
        }

        .usage-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .usage-stat {
            text-align: center;
        }

        .usage-stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .usage-stat-value.input { color: var(--accent-blue); }
        .usage-stat-value.output { color: var(--accent-purple); }
        .usage-stat-value.total { color: var(--accent-cyan); }

        .usage-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .usage-bar-container {
            margin-top: 16px;
        }

        .usage-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .usage-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .usage-bar-fill {
            height: 100%;
            background: var(--gradient-1);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Cost Tracking Card */
        .cost-tracking {
            grid-column: span 6;
        }

        .cost-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .cost-item {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            text-align: center;
        }

        .cost-value {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-green);
        }

        .cost-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-transform: uppercase;
        }

        /* Activity Log Card */
        .activity-log {
            grid-column: span 8;
        }

        .activity-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .activity-list::-webkit-scrollbar {
            width: 6px;
        }

        .activity-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .activity-item:last-child { border-bottom: none; }
        .activity-item:hover { background: var(--bg-secondary); }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .activity-icon.system { background: rgba(88, 166, 255, 0.15); }
        .activity-icon.agent { background: rgba(163, 113, 247, 0.15); }
        .activity-icon.success { background: rgba(63, 185, 80, 0.15); }
        .activity-icon.error { background: rgba(248, 81, 73, 0.15); }

        .activity-content { flex: 1; min-width: 0; }

        .activity-text {
            font-size: 13px;
            color: var(--text-primary);
            word-break: break-word;
        }

        .activity-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Presence Card */
        .presence-card {
            grid-column: span 4;
        }

        .presence-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 320px;
            overflow-y: auto;
        }

        .presence-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .presence-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .presence-info { flex: 1; }

        .presence-name {
            font-size: 13px;
            font-weight: 500;
        }

        .presence-meta {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .presence-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
        }

        /* Config Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-header p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--gradient-1);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 13px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: repeat(6, 1fr);
            }
            .gateway-status, .model-info, .sessions-card { grid-column: span 3; }
            .token-usage, .cost-tracking { grid-column: span 6; }
            .activity-log { grid-column: span 6; }
            .presence-card { grid-column: span 6; }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                padding: 12px;
            }
            .gateway-status, .model-info, .sessions-card,
            .token-usage, .cost-tracking, .activity-log,
            .presence-card {
                grid-column: span 1;
            }
            .header {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }
            .header-right { width: 100%; justify-content: space-between; }
            .usage-stats, .cost-grid { grid-template-columns: repeat(2, 1fr); }
            .session-stats { grid-template-columns: 1fr; }
        }

        /* Avatar Moods */
        .avatar.thinking { animation: think 1s ease-in-out infinite; }
        .avatar.working { animation: work 0.5s ease-in-out infinite; }
        .avatar.celebrating { animation: celebrate 0.3s ease-in-out infinite; }
        .avatar.sleeping { opacity: 0.6; }
        .avatar.error { filter: hue-rotate(180deg); }

        @keyframes think {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }

        @keyframes work {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes celebrate {
            0%, 100% { transform: rotate(-5deg) scale(1.05); }
            50% { transform: rotate(5deg) scale(1.1); }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="avatar-container">
                <div class="avatar-ring"></div>
                <div class="avatar" id="chadAvatar" title="Click to change mood">ü§ñ</div>
                <div class="avatar-status offline" id="avatarStatus"></div>
            </div>
            <div class="header-title">
                <h1>Chad Dashboard v2</h1>
                <p id="connectionStatus">Disconnected</p>
            </div>
        </div>
        <div class="header-right">
            <div class="status-badge">
                <div class="status-dot offline" id="statusDot"></div>
                <span id="currentState">Offline</span>
            </div>
            <div class="time-display" id="timeDisplay">--:--:--</div>
            <button class="config-btn" id="configBtn" title="Configure">‚öôÔ∏è</button>
        </div>
    </header>

    <main class="dashboard">
        <!-- Gateway Status -->
        <section class="card gateway-status">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-title-icon">üåê</span>
                    Gateway Status
                </div>
                <span class="card-badge" id="gatewayBadge">Offline</span>
            </div>
            <div class="card-content">
                <div class="status-grid">
                    <div class="status-row">
                        <span class="status-label">Gateway</span>
                        <span class="status-value offline" id="gwStatus">Disconnected</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Uptime</span>
                        <span class="status-value" id="gwUptime">--</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Version</span>
                        <span class="status-value" id="gwVersion">--</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Host</span>
                        <span class="status-value" id="gwHost">--</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Model Info -->
        <section class="card model-info">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-title-icon">üß†</span>
                    Active Model
                </div>
            </div>
            <div class="card-content">
                <div class="model-display">
                    <div class="model-name" id="modelName">--</div>
                    <div class="model-meta">
                        <span class="model-tag" id="modelProvider">--</span>
                        <span class="model-tag" id="modelContext">--</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sessions -->
        <section class="card sessions-card">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-title-icon">üí¨</span>
                    Sessions
                </div>
            </div>
            <div class="card-content">
                <div class="session-stats">
                    <div class="session-stat">
                        <div class="session-stat-value" id="activeSessions">0</div>
                        <div class="session-stat-label">Active</div>
                    </div>
                    <div class="session-stat">
                        <div class="session-stat-value" id="totalSessions">0</div>
                        <div class="session-stat-label">Total</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Token Usage -->
        <section class="card token-usage">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-title-icon">üìä</span>
                    Token Usage
                </div>
                <span class="card-badge" id="tokenPeriod">Session</span>
            </div>
            <div class="card-content">
                <div class="usage-stats">
                    <div class="usage-stat">
                        <div class="usage-stat-value input" id="inputTokens">0</div>
                        <div class="usage-stat-label">Input</div>
                    </div>
                    <div class="usage-stat">
                        <div class="usage-stat-value output" id="outputTokens">0</div>
                        <div class="usage-stat-label">Output</div>
                    </div>
                    <div class="usage-stat">
                        <div class="usage-stat-value total" id="totalTokens">0</div>
                        <div class="usage-stat-label">Total</div>
                    </div>
                </div>
                <div class="usage-bar-container">
                    <div class="usage-bar-label">
                        <span>Context Usage</span>
                        <span id="contextPercent">0%</span>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-bar-fill" id="contextFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Cost Tracking -->
        <section class="card cost-tracking">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-title-icon">üí∞</span>
                    Cost Tracking
                </div>
                <span class="card-badge live" id="costLive">Live</span>
            </div>
            <div class="card-content">
                <div class="cost-grid">
                    <div class="cost-item">
                        <div class="cost-value" id="costToday">$0.00</div>
                        <div class="cost-label">Today</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-value" id="costWeek">$0.00</div>
                        <div class="cost-label">This Week</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-value" id="costMonth">$0.00</div>
                        <div class="cost-label">This Month</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Activity Log -->
        <section class="card activity-log">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-title-icon">üìú</span>
                    Activity Log
                </div>
                <span class="card-badge" id="activityCount">0 events</span>
            </div>
            <div class="card-content">
                <div class="activity-list" id="activityList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì°</div>
                        <div class="empty-state-text">Connect to Gateway to see activity</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Presence -->
        <section class="card presence-card">
            <div class="card-header">
                <div class="card-title">
                    <span class="card-title-icon">üë•</span>
                    Connected Clients
                </div>
                <span class="card-badge" id="presenceCount">0</span>
            </div>
            <div class="card-content">
                <div class="presence-list" id="presenceList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üëª</div>
                        <div class="empty-state-text">No clients connected</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Config Modal -->
    <div class="modal-overlay" id="configModal">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Gateway Configuration</h2>
                <p>Connect to your OpenClaw Gateway</p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Gateway URL</label>
                    <input type="text" id="gatewayUrl" placeholder="ws://127.0.0.1:18789">
                </div>
                <div class="form-group">
                    <label>Auth Token</label>
                    <input type="password" id="gatewayToken" placeholder="Your gateway token">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelConfig">Cancel</button>
                <button class="btn btn-primary" id="saveConfig">Connect</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Chad Dashboard v2 - Gateway Integration
        // ==========================================

        const CONFIG_KEY = 'chad-dashboard-config';
        let ws = null;
        let reconnectTimeout = null;
        let requestId = 1;
        let pendingRequests = {};
        let activities = [];
        let presence = [];
        let isConnected = false;

        // Avatar moods
        const avatarMoods = {
            idle: { emoji: 'ü§ñ', class: '' },
            thinking: { emoji: 'ü§î', class: 'thinking' },
            working: { emoji: '‚ö°', class: 'working' },
            coding: { emoji: 'üë®‚Äçüíª', class: 'working' },
            celebrating: { emoji: 'üéâ', class: 'celebrating' },
            sleeping: { emoji: 'üò¥', class: 'sleeping' },
            error: { emoji: 'üòµ', class: 'error' }
        };
        let currentMood = 'idle';

        // Load config from localStorage
        function loadConfig() {
            const saved = localStorage.getItem(CONFIG_KEY);
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {}
            }
            return { url: 'ws://127.0.0.1:18789', token: '' };
        }

        // Save config
        function saveConfig(url, token) {
            localStorage.setItem(CONFIG_KEY, JSON.stringify({ url, token }));
        }

        // Update time display
        function updateTime() {
            document.getElementById('timeDisplay').textContent = 
                new Date().toLocaleTimeString('en-US', { hour12: false });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Format numbers
        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toString();
        }

        // Format uptime
        function formatUptime(ms) {
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            const d = Math.floor(h / 24);
            if (d > 0) return `${d}d ${h % 24}h`;
            if (h > 0) return `${h}h ${m % 60}m`;
            if (m > 0) return `${m}m ${s % 60}s`;
            return `${s}s`;
        }

        // Set connection status
        function setConnectionStatus(status) {
            isConnected = status === 'connected';
            const statusDot = document.getElementById('statusDot');
            const avatarStatus = document.getElementById('avatarStatus');
            const connectionStatus = document.getElementById('connectionStatus');
            const currentState = document.getElementById('currentState');
            const gatewayBadge = document.getElementById('gatewayBadge');
            const gwStatus = document.getElementById('gwStatus');

            statusDot.className = 'status-dot ' + (status === 'connected' ? '' : status === 'connecting' ? 'connecting' : 'offline');
            avatarStatus.className = 'avatar-status ' + (status === 'connected' ? '' : status === 'connecting' ? 'connecting' : 'offline');
            
            const statusTexts = {
                connected: 'Connected to Gateway',
                connecting: 'Connecting...',
                disconnected: 'Disconnected'
            };
            connectionStatus.textContent = statusTexts[status] || 'Disconnected';
            currentState.textContent = status === 'connected' ? 'Online' : status === 'connecting' ? 'Connecting' : 'Offline';
            gatewayBadge.textContent = status === 'connected' ? 'Online' : 'Offline';
            gatewayBadge.className = 'card-badge' + (status === 'connected' ? ' live' : '');
            gwStatus.textContent = status === 'connected' ? 'Connected' : 'Disconnected';
            gwStatus.className = 'status-value ' + (status === 'connected' ? 'online' : 'offline');

            setMood(status === 'connected' ? 'idle' : status === 'connecting' ? 'thinking' : 'sleeping');
        }

        // Set avatar mood
        function setMood(mood) {
            currentMood = mood;
            const avatar = document.getElementById('chadAvatar');
            const m = avatarMoods[mood] || avatarMoods.idle;
            avatar.textContent = m.emoji;
            avatar.className = 'avatar ' + m.class;
        }

        // Add activity
        function addActivity(type, text, timestamp = new Date()) {
            activities.unshift({ type, text, timestamp });
            if (activities.length > 50) activities.pop();
            renderActivities();
        }

        // Render activities
        function renderActivities() {
            const list = document.getElementById('activityList');
            if (activities.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì°</div>
                        <div class="empty-state-text">Connect to Gateway to see activity</div>
                    </div>
                `;
                document.getElementById('activityCount').textContent = '0 events';
                return;
            }

            const icons = { system: '‚öôÔ∏è', agent: 'ü§ñ', success: '‚úÖ', error: '‚ùå' };
            list.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <div class="activity-icon ${a.type}">${icons[a.type] || 'üìå'}</div>
                    <div class="activity-content">
                        <div class="activity-text">${a.text}</div>
                        <div class="activity-time">${formatTimeAgo(a.timestamp)}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('activityCount').textContent = `${activities.length} events`;
        }

        // Format time ago
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }

        // Render presence
        function renderPresence() {
            const list = document.getElementById('presenceList');
            document.getElementById('presenceCount').textContent = presence.length.toString();
            
            if (presence.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üëª</div>
                        <div class="empty-state-text">No clients connected</div>
                    </div>
                `;
                return;
            }

            list.innerHTML = presence.map(p => `
                <div class="presence-item">
                    <div class="presence-avatar">${p.platform === 'darwin' ? 'üçé' : p.platform === 'linux' ? 'üêß' : 'üíª'}</div>
                    <div class="presence-info">
                        <div class="presence-name">${p.host || p.ip || 'Unknown'}</div>
                        <div class="presence-meta">${p.mode || 'client'} ¬∑ ${p.version || '--'}</div>
                    </div>
                    <div class="presence-status"></div>
                </div>
            `).join('');
        }

        // Update dashboard with health data
        function updateHealth(health) {
            // Model info
            if (health.model) {
                document.getElementById('modelName').textContent = health.model.id || health.model || '--';
                const parts = (health.model.id || health.model || '').split('/');
                document.getElementById('modelProvider').textContent = parts[0] || '--';
                document.getElementById('modelContext').textContent = health.model.contextWindow ? `${Math.round(health.model.contextWindow / 1000)}K ctx` : '--';
            }

            // Sessions
            if (health.sessions) {
                document.getElementById('activeSessions').textContent = health.sessions.active || 0;
                document.getElementById('totalSessions').textContent = health.sessions.total || health.sessions.count || 0;
            }

            // Tokens
            if (health.tokens || health.usage) {
                const tokens = health.tokens || health.usage || {};
                document.getElementById('inputTokens').textContent = formatNumber(tokens.input || tokens.inputTokens || 0);
                document.getElementById('outputTokens').textContent = formatNumber(tokens.output || tokens.outputTokens || 0);
                document.getElementById('totalTokens').textContent = formatNumber((tokens.input || 0) + (tokens.output || 0) || tokens.total || 0);
                
                const contextMax = health.model?.contextWindow || 200000;
                const used = tokens.total || ((tokens.input || 0) + (tokens.output || 0));
                const percent = Math.min(100, Math.round((used / contextMax) * 100));
                document.getElementById('contextPercent').textContent = `${percent}%`;
                document.getElementById('contextFill').style.width = `${percent}%`;
            }

            // Cost
            if (health.cost || health.costs) {
                const cost = health.cost || health.costs || {};
                document.getElementById('costToday').textContent = `$${(cost.today || cost.daily || 0).toFixed(2)}`;
                document.getElementById('costWeek').textContent = `$${(cost.week || cost.weekly || 0).toFixed(2)}`;
                document.getElementById('costMonth').textContent = `$${(cost.month || cost.monthly || cost.total || 0).toFixed(2)}`;
            }
        }

        // Update with snapshot data
        function updateSnapshot(snapshot) {
            if (snapshot.uptimeMs) {
                document.getElementById('gwUptime').textContent = formatUptime(snapshot.uptimeMs);
            }
            if (snapshot.health) {
                updateHealth(snapshot.health);
            }
            if (snapshot.presence) {
                presence = Array.isArray(snapshot.presence) ? snapshot.presence : [];
                renderPresence();
            }
        }

        // WebSocket connection
        function connect() {
            const config = loadConfig();
            if (!config.url) {
                showConfigModal();
                return;
            }

            if (ws) {
                ws.close();
            }

            setConnectionStatus('connecting');
            addActivity('system', `Connecting to ${config.url}...`);

            try {
                ws = new WebSocket(config.url);
            } catch (e) {
                setConnectionStatus('disconnected');
                addActivity('error', `Failed to create WebSocket: ${e.message}`);
                scheduleReconnect();
                return;
            }

            ws.onopen = () => {
                // Send connect request
                const connectReq = {
                    type: 'req',
                    id: requestId++,
                    method: 'connect',
                    params: {
                        minProtocol: 1,
                        maxProtocol: 1,
                        client: {
                            id: 'chad-dashboard-v2',
                            displayName: 'Chad Dashboard',
                            version: '2.0.0',
                            platform: 'web',
                            mode: 'dashboard'
                        },
                        caps: ['presence', 'health'],
                        auth: config.token ? { token: config.token } : undefined
                    }
                };
                ws.send(JSON.stringify(connectReq));
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleMessage(msg);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addActivity('error', 'WebSocket error');
            };

            ws.onclose = (event) => {
                setConnectionStatus('disconnected');
                addActivity('system', `Disconnected (code: ${event.code})`);
                scheduleReconnect();
            };
        }

        // Handle incoming messages
        function handleMessage(msg) {
            if (msg.type === 'res') {
                if (msg.payload?.type === 'hello-ok') {
                    // Connected successfully
                    setConnectionStatus('connected');
                    addActivity('success', 'Connected to Gateway');
                    
                    // Update version/host from payload
                    if (msg.payload.version) {
                        document.getElementById('gwVersion').textContent = msg.payload.version;
                    }
                    if (msg.payload.host) {
                        document.getElementById('gwHost').textContent = msg.payload.host;
                    }

                    // Update snapshot if available
                    if (msg.payload.snapshot) {
                        updateSnapshot(msg.payload.snapshot);
                    }

                    // Request health for more detailed info
                    sendRequest('health');
                    sendRequest('status');
                } else if (msg.ok === false) {
                    addActivity('error', `Error: ${msg.error?.message || 'Unknown error'}`);
                    if (msg.error?.code === 'AUTH_REQUIRED' || msg.error?.code === 'UNAUTHORIZED') {
                        showConfigModal();
                    }
                } else if (pendingRequests[msg.id]) {
                    const method = pendingRequests[msg.id];
                    delete pendingRequests[msg.id];
                    
                    if (method === 'health' && msg.payload) {
                        updateHealth(msg.payload);
                        addActivity('system', 'Health data updated');
                    } else if (method === 'status' && msg.payload) {
                        if (msg.payload.version) {
                            document.getElementById('gwVersion').textContent = msg.payload.version;
                        }
                    }
                }
            } else if (msg.type === 'event') {
                handleEvent(msg);
            }
        }

        // Handle events
        function handleEvent(msg) {
            const { event, payload } = msg;
            
            switch (event) {
                case 'presence':
                    if (payload) {
                        presence = Array.isArray(payload) ? payload : payload.entries || [];
                        renderPresence();
                    }
                    break;
                case 'agent':
                    setMood('working');
                    addActivity('agent', payload?.summary || 'Agent activity');
                    setTimeout(() => setMood('idle'), 3000);
                    break;
                case 'tick':
                    // Keepalive - update uptime
                    if (payload?.uptimeMs) {
                        document.getElementById('gwUptime').textContent = formatUptime(payload.uptimeMs);
                    }
                    break;
                case 'shutdown':
                    addActivity('system', `Gateway shutting down: ${payload?.reason || 'unknown'}`);
                    setMood('sleeping');
                    break;
            }
        }

        // Send request
        function sendRequest(method, params = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            const id = requestId++;
            pendingRequests[id] = method;
            ws.send(JSON.stringify({ type: 'req', id, method, params }));
        }

        // Schedule reconnect
        function scheduleReconnect() {
            if (reconnectTimeout) clearTimeout(reconnectTimeout);
            reconnectTimeout = setTimeout(connect, 5000);
        }

        // Config modal
        function showConfigModal() {
            const config = loadConfig();
            document.getElementById('gatewayUrl').value = config.url || '';
            document.getElementById('gatewayToken').value = config.token || '';
            document.getElementById('configModal').classList.add('active');
        }

        function hideConfigModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        // Event listeners
        document.getElementById('configBtn').addEventListener('click', showConfigModal);
        document.getElementById('cancelConfig').addEventListener('click', hideConfigModal);
        document.getElementById('saveConfig').addEventListener('click', () => {
            const url = document.getElementById('gatewayUrl').value.trim();
            const token = document.getElementById('gatewayToken').value.trim();
            saveConfig(url, token);
            hideConfigModal();
            connect();
        });

        document.getElementById('configModal').addEventListener('click', (e) => {
            if (e.target.id === 'configModal') hideConfigModal();
        });

        document.getElementById('chadAvatar').addEventListener('click', () => {
            const moods = Object.keys(avatarMoods);
            const idx = moods.indexOf(currentMood);
            setMood(moods[(idx + 1) % moods.length]);
        });

        // Keyboard shortcut
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') hideConfigModal();
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                if (isConnected) {
                    sendRequest('health');
                    addActivity('system', 'Manual refresh triggered');
                }
            }
        });

        // Initialize
        const config = loadConfig();
        if (config.url && config.token) {
            connect();
        } else {
            showConfigModal();
        }

        // Refresh health every 30s when connected
        setInterval(() => {
            if (isConnected) {
                sendRequest('health');
            }
        }, 30000);

        // Update activity times every minute
        setInterval(renderActivities, 60000);
    </script>
</body>
</html>
